<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi"
      th:replace="layout :: main(~{::body}, ~{::title})">
<head>
    <meta charset="UTF-8">
    <title>Quản lý sản phẩm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<section>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-0">Danh sách sản phẩm</h2>
            <small class="text-muted">Quản lý kho hàng (Bài 3)</small>
        </div>
        <button class="btn btn-success" onclick="showAddForm()">+ Thêm sản phẩm</button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle" id="productsTable">
                    <thead class="table-primary">
                    <tr>
                        <th>ID</th>
                        <th>Tên sản phẩm</th>
                        <th>Giá</th>
                        <th>Số lượng</th>
                        <th>Mô tả</th>
                        <th>Ngày tạo</th>
                        <th>Ngày cập nhật</th>
                        <th class="text-end">Hành động</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="p : ${products}" 
                        th:id="'product-' + ${p.id}"
                        th:with="priceText=${#numbers.formatDecimal(p.price,1,'COMMA',2,'POINT')}">
                        <td th:text="${p.id}"></td>
                        <td th:text="${p.name}"></td>
                        <td th:text="${priceText} + ' VND'"></td>
                        <td th:text="${p.quantity}"></td>
                        <td th:text="${p.description}"></td>
                        <td th:text="${#temporals.format(p.createdAt, 'dd/MM/yyyy HH:mm')}"></td>
                        <td th:text="${#temporals.format(p.updatedAt, 'dd/MM/yyyy HH:mm')}"></td>
                        <td class="text-end">
                            <button type="button" class="btn btn-sm btn-outline-info me-1"
                                    th:attr="data-id=${p.id}, 
                                             data-name=${p.name}, 
                                             data-price=${p.price}, 
                                             data-quantity=${p.quantity}, 
                                             data-description=${p.description}"
                                    onclick="viewProduct(this)">
                                Xem
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary me-1"
                                    th:attr="data-id=${p.id}, 
                                             data-name=${p.name}, 
                                             data-price=${p.price}, 
                                             data-quantity=${p.quantity}, 
                                             data-description=${p.description}"
                                    onclick="editProduct(this)">
                                Sửa
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger"
                th:onclick="'deleteProduct(' + ${p.id} + ')'">
                                Xóa
                            </button>

                        </td>
                    </tr>
                    <tr id="noProductsRow" th:if="${#lists.isEmpty(products)}">
                        <td colspan="8" class="text-center text-muted py-4">Chưa có sản phẩm nào.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Form Thêm/Sửa sản phẩm -->
    <div id="formContainer" class="card shadow-sm mt-4" style="display:none;">
        <div class="card-body">
            <h5 class="card-title"></h5>
            <form id="productForm" class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Tên sản phẩm</label>
                    <input type="text" class="form-control" name="name" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Giá</label>
                    <input type="number" step="0.01" class="form-control" name="price" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Số lượng</label>
                    <input type="number" class="form-control" name="quantity" required>
                </div>
                <div class="col-12">
                    <label class="form-label">Mô tả</label>
                    <input type="text" class="form-control" name="description" required>
                </div>
                <div class="col-12 d-flex justify-content-end">
                    <button type="button" class="btn btn-outline-secondary me-2" onclick="hideForm()">Hủy</button>
                    <button type="submit" class="btn btn-primary">Lưu</button>
                </div>
            </form>
        </div>
    </div>
</section>

<!-- Modal Xem sản phẩm -->
<div class="modal fade" id="viewProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết sản phẩm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <p><strong>ID:</strong> <span id="viewId"></span></p>
                <p><strong>Tên:</strong> <span id="viewName"></span></p>
                <p><strong>Giá:</strong> <span id="viewPrice"></span> VND</p>
                <p><strong>Số lượng:</strong> <span id="viewQuantity"></span></p>
                <p><strong>Mô tả:</strong> <span id="viewDescription"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const formContainer = document.getElementById('formContainer');
    const formTitle = formContainer.querySelector('.card-title');
    const productForm = document.getElementById('productForm');
    const productsTable = document.getElementById('productsTable').querySelector('tbody');
    let currentProductId = null;

    function showAddForm() {
        formTitle.innerText = 'Thêm sản phẩm';
        currentProductId = null;
        productForm.name.value = '';
        productForm.price.value = '';
        productForm.quantity.value = '';
        productForm.description.value = '';
        formContainer.style.display = 'block';
        formContainer.scrollIntoView({behavior: 'smooth'});
    }

    function editProduct(btn) {
        currentProductId = btn.getAttribute('data-id');
        formTitle.innerText = 'Sửa sản phẩm';
        productForm.name.value = btn.getAttribute('data-name');
        productForm.price.value = btn.getAttribute('data-price');
        productForm.quantity.value = btn.getAttribute('data-quantity');
        productForm.description.value = btn.getAttribute('data-description');

        formContainer.style.display = 'block';
        formContainer.scrollIntoView({behavior: 'smooth'});
    }

    function hideForm() {
        formContainer.style.display = 'none';
    }

    function viewProduct(btn) {
        document.getElementById('viewId').innerText = btn.getAttribute('data-id');
        document.getElementById('viewName').innerText = btn.getAttribute('data-name');
        document.getElementById('viewPrice').innerText = btn.getAttribute('data-price');
        document.getElementById('viewQuantity').innerText = btn.getAttribute('data-quantity');
        document.getElementById('viewDescription').innerText = btn.getAttribute('data-description');

        const modal = new bootstrap.Modal(document.getElementById('viewProductModal'));
        modal.show();
    }

    function deleteProduct(id) {
    if (!confirm('Bạn có chắc muốn xóa sản phẩm này?')) return;

    fetch('/products/' + id, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Xóa thất bại: ' + response.status);
        // Xóa dòng khỏi bảng
        const row = document.getElementById('product-' + id);
        if (row) row.remove();
        alert('Xóa thành công!');

        // Nếu không còn dòng nào, thêm thông báo
        if (productsTable.querySelectorAll('tr').length === 0) {
            const noRow = document.createElement('tr');
            noRow.id = 'noProductsRow';
            noRow.innerHTML = '<td colspan="8" class="text-center text-muted py-4">Chưa có sản phẩm nào.</td>';
            productsTable.appendChild(noRow);
        }
    })
    .catch(err => alert('Lỗi: ' + err.message));
}


    productForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const data = {
            name: productForm.name.value,
            price: parseFloat(productForm.price.value),
            quantity: parseInt(productForm.quantity.value),
            description: productForm.description.value
        };

        const method = currentProductId ? 'PUT' : 'POST';
        const url = currentProductId ? '/products/' + currentProductId : '/products';

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => {
            if (!res.ok) throw new Error(currentProductId ? 'Cập nhật thất bại' : 'Thêm thất bại');
            return res.json();
        })
        .then(product => {
            alert(currentProductId ? 'Cập nhật thành công!' : 'Thêm thành công!');
            window.location.reload(); // Có thể thay bằng cập nhật DOM để tránh reload
        })
        .catch(err => alert(err));
    });
</script>
</body>
</html>
